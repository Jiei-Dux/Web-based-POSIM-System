<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Home | Meogeo Sarang Korean Mart </title>

    <!-- Bootstrap CSS -->
    <link href="../css/Bootstrap CSS/bootstrap.min.css" rel="stylesheet">
    <!-- CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/Home.css">
    <link rel="stylesheet" href="../css/loading.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .header .searchbar {
            flex-grow: 1;
            margin-right: 20px;
        }

        .header .btn-link {
            padding: 0;
            margin-left: 10px;
        }

        .divider {
            height: 4px;
            background-color: #000;
            margin: 0;
        }

        .content {
            height: calc(100vh - 150px);
            overflow-y: scroll;
        }

        .navbar-vertical {
            height: 100%;
            padding: 20px 0;
        }

        .products-column {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-column {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background-color: transparent;
        }

        .product-card {
            background-color: pink;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            background-color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            margin: 0 auto 10px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .cart-container {
            height: 65%;
            overflow-y: auto;
            /* padding: 20px; */
        }

        .quantity-control {
            display: flex;
            align-items: center;
        }

        .quantity-control button {
            width: 25px;
            height: 25px;
            padding: 0;
            font-size: 18px;
            line-height: 1;
        }

        .quantity-control input {
            width: 40px;
            text-align: center;
            margin: 0 5px;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            appearance: none;
            margin: 0;
        }

        input[type="number"] {
            appearance: textfield;
        }

        .navbar-vertical {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }

        .navbar-vertical .nav-link {
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
        }

        .navbar-vertical .beauty {
            display: block;
            text-align: center;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
        }

        .button-container .btn {
            margin-right: 10px;
        }

        .button-container .btn:last-child {
            margin-right: 0;
        }

        .btnfontSize {
            align-content: center;
        }

        .Cart {
            padding-bottom: 20px;
        }

        .custom-tooltip {
            --bs-tooltip-bg: var(--bd-violet-bg);
            --bs-tooltip-color: var(--bs-white);
        }

        .btn-link {
            padding: 0;
        }

        .btn-link:hover {
            opacity: 0.5;
        }

        .delete-button {
            border: none;
            background: none;
            cursor: pointer;
            margin-top: 0;
        }

        .delete-button img {
            width: 40px;
            height: 40px;
        }

        .quantity-control button {
            width: 25px;
            height: 25px;
            padding: 0;
            font-size: 18px;
            line-height: 1;
            border: 1px solid #000;
            background-color: transparent;
            color: #000000;
        }

        .quantity-control button:hover {
            background-color: #888888;
            color: #fff;
        }

        .logout-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .logout-popup-content {
            text-align: center;
        }

        .popup-button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        .popup-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body class="Main">
    <!-- Loading Animation -->
    <div id="loading">
        <div id="loading-center"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-1 logo">
                    <a href="../html/Home.html">
                        <img src="../Assets/MSKM_Logo.png" width="120" height="120">
                    </a>
                    <span class="logo_tooltip_text" id="tooltip">Homepage</span>
                </div>
                <div class="col-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="searchbar flex-grow-1 mr-3">
                            <input type="text" placeholder="Search for Products..." class="form-control">
                            <button type="submit" class="searchbar_button btn btn-link ml-2"></button>
                        </div>
                        <div>
                            <a href="#" class="btn btn-link mr-2">
                                <img src="../Assets/CONNECTION.png" alt="Connection" width="30" height="30">
                            </a>
                            <a href="#" class="btn btn-link">
                                <img src="../Assets/REFRESH_CONNECTION.png" alt="Refresh Connection" width="30"
                                    height="30">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Divider -->
    <div class="divider"></div>

    <!-- Main Content -->
    <div class="content container-fluid">
        <div class="row h-100">

            <!-- Navbar Column -->
            <div class="col-1 p-0">
                <div class="navbar-vertical nav nav-pills flex-column align-items-center justify-content-center h-100">
                    <a class="nav-link text-center active" href="#">
                        <img src="../Assets/HOME.png" class="buttonIcons d-block mx-auto"><span
                            class="beauty">HOME</span>
                    </a>
                    <a class="nav-link text-center" href="#">
                        <img src="../Assets/STOCKS.png" class="buttonIcons d-block mx-auto"><span
                            class="beauty">STOCKS</span>
                    </a>
                    <a class="nav-link text-center" href="#">
                        <img src="../Assets/REPORTS.png" class="buttonIcons d-block mx-auto"><span
                            class="beauty">REPORTS</span>
                    </a>
                    <a class="nav-link text-center" href="#">
                        <img src="../Assets/SETTINGS.png" class="buttonIcons d-block mx-auto"><span
                            class="beauty">SETTINGS</span>
                    </a>
                    <div class="navbarLogo_User">
                        <a class="nav-link" href="#">
                            <img src="../Assets/USER.png" class="buttonIcons">
                        </a>
                        <span class="logo_tooltip_text" id="tooltipUser">User</span>
                    </div>
                    <div class="navbarLogo_Logout">
                        <a class="nav-link" href="#">
                            <img src="../Assets/LOGOUT.png" class="buttonIcons">
                        </a>
                        <span class="logo_tooltip_text" id="tooltipLogout">Logout</span>
                    </div>

                    <!-- Logout Confirmation Popup -->
                    <div id="logout-popup" class="logout-popup">
                        <div class="logout-popup-content">
                            <p>Are you sure you want to log out?</p>
                            <button id="confirm-logout" class="popup-button">Logout</button>
                            <button id="cancel-logout" class="popup-button">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Column -->
            <div class="col-6 products-column">
                <div class="horizontal-navbar nav nav-pills mb-3">
                    <a class="nav-link active" href="#" data-category="DRINKS">Drinks</a>
                    <a class="nav-link" href="#" data-category="FOOD">Food</a>
                    <a class="nav-link" href="#" data-category="WHOLESALE">Wholesale</a>
                    <a class="nav-link" href="#" data-category="OTHERS">Others</a>
                </div>
                <div id="productsContainer"></div>
            </div>

            <!-- Shopping Cart Column -->
            <div class="col-5 cart-column">
                <div class="d-flex justify-content-between">
                    <h4 class="Cart">Cart</h4>
                    <a href="#" class="delete-button" onclick="clearCart()">
                        <img src="../Assets/DELETE.png">
                    </a>
                </div>
                <div class="cart-container" id="cartItems"></div>
                <div class="mt-3">
                    <strong>Total: PHP <span id="cartTotal">0.00</span></strong>
                </div>
                <div class="button-container mt-3 btnfontSize">
                    <button class="btn btn-secondary w-50 mr-2">Pay Later</button>
                    <button class="btn btn-primary w-50">Proceed to Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScripts -->
    <script src="../js/Bootstrap JS/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/Home.js"></script>
    <script src="../js/Database.js"></script>
    <script>
        const dbName = "MSKM_Inventory_Database";
        const storeName = "products";

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onerror = (event) => reject("IndexedDB error: " + event.target.error);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    db.createObjectStore(storeName, { keyPath: "Product_Name" });
                };
            });
        }

        async function displayProducts(category) {
            const products = await fetchProducts(category);
            console.log('Products to display:', products);
            const productsContainer = document.getElementById('productsContainer');
            if (!productsContainer) {
                console.error('productsContainer is null');
                return;
            }
            productsContainer.innerHTML = '';
            const row = document.createElement('div');
            row.className = 'row';
            products.forEach(product => {
                const productCard = createProductCard(product);
                row.appendChild(productCard);
            });
            productsContainer.appendChild(row);
        }

        async function saveProductsToIndexedDB(products) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readwrite");
                const store = transaction.objectStore(storeName);

                products.forEach(product => {
                    const request = store.put(product);
                    request.onerror = (event) => {
                        console.error('Error saving product to IndexedDB:', event.target.error);
                    };
                });

                transaction.oncomplete = () => resolve();
                transaction.onerror = (event) => {
                    console.error('Transaction error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function getProductsFromIndexedDB(category) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readonly");
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => {
                    const products = request.result.filter(p => p.Product_Category === category);
                    resolve(products);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function fetchProducts(category) {
            try {
                console.log('Fetching products for category:', category);
                const query = supabase
                    .from('Product_Table')
                    .select('Product_Name, Product_Price, Product_Category')
                    .eq('Product_Category', category);

                console.log('Query:', query.toString());

                const { data, error } = await query;

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                console.log('Fetched data:', data);
                if (data.length === 0) {
                    console.log('No products found for category:', category);
                }
                await saveProductsToIndexedDB(data);
                return data;
            } catch (error) {
                console.error('Error fetching from Supabase:', error);
                if (error.message) console.error('Error message:', error.message);
                if (error.details) console.error('Error details:', error.details);
                if (error.hint) console.error('Error hint:', error.hint);
                try {
                    const offlineData = await getProductsFromIndexedDB(category);
                    console.log('Offline data:', offlineData);
                    return offlineData;
                } catch (offlineError) {
                    console.error('Error fetching from IndexedDB:', offlineError);
                    return [];
                }
            }
        }

        async function initialize() {
            initSupabase();
            try {
                await initDB();
                console.log("IndexedDB initialized");
                await displayProducts('DRINKS');
            } catch (error) {
                console.error("Failed to initialize:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);

        document.querySelectorAll('.horizontal-navbar .nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const category = e.target.getAttribute('data-category');
                displayProducts(category);
                document.querySelectorAll('.horizontal-navbar .nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
            });
        });

        function createProductCard(product) {
            const col = document.createElement('div');
            col.className = 'col-6 col-lg-4 mb-3';
            col.innerHTML = `
                <div class="product-card">
                    <div class="product-image">?</div>
                        <h6>${product.Product_Name}</h6>
                        <p class="mb-0">PHP ${product.Product_Price.toFixed(2)}</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="addToCart('${product.Product_Name}', ${product.Product_Price})">Add to Cart</button>
                </div>
            `;
            return col;
        }

        let cart = [];

        function addToCart(name, price) {
            const item = cart.find(item => item.name === name);
            if (item) {
                updateQuantity(name, 1);
            } else {
                cart.push({ name, price, quantity: 1 });
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartContainer = document.getElementById('cartItems');
            if (!cartContainer) {
                console.error('cartItems container is null');
                return;
            }
            cartContainer.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <h6>${item.name}</h6>
                        <p>PHP ${item.price.toFixed(2)}</p>
                    </div>
                    <div class="quantity-control">
                        <button onclick="updateQuantity('${item.name}', -1)">-</button>
                        <input type="number" value="${item.quantity}" min="1" onchange="changeQuantity('${item.name}', this.value)">
                        <button onclick="updateQuantity('${item.name}', 1)">+</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            document.getElementById('cartTotal').textContent = total.toFixed(2);
        }

        function changeQuantity(name, newQuantity) {
            const parsedQuantity = parseInt(newQuantity, 10);
            if (!isNaN(parsedQuantity) && parsedQuantity >= 1) {
                const item = cart.find(item => item.name === name);
                if (item) {
                    item.quantity = parsedQuantity;
                    updateCartDisplay();
                }
            }
        }

        function updateQuantity(name, change) {
            const item = cart.find(item => item.name === name);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.name !== name);
                }
            }
            updateCartDisplay();
        }

        function clearCart() {
            cart = [];
            updateCartDisplay();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const logoutLink = document.querySelector('.navbarLogo_Logout .nav-link');
            const logoutPopup = document.getElementById('logout-popup');
            const confirmLogoutButton = document.getElementById('confirm-logout');
            const cancelLogoutButton = document.getElementById('cancel-logout');

            logoutLink.addEventListener('click', (event) => {
                event.preventDefault();
                logoutPopup.style.display = 'block';
            });

            cancelLogoutButton.addEventListener('click', () => {
                logoutPopup.style.display = 'none';
            });

            confirmLogoutButton.addEventListener('click', () => {
                const currentDateTime = new Date();
                console.log(`Logout clicked at: ${currentDateTime.toString()}`);
                window.location.href = 'index.html';
            });
        });
    </script>
</body>

</html>